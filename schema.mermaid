%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#F9E79F', 'edgeLabelBackground':'#FFF'}}}%%
flowchart TD
    A[Начало: СгенерироватьДокументПоШаблону] --> B{Проверить настройки\nПроверитьНастройкиИнтеграции}
    B -->|Ошибка| B1[Сообщить: 'Не задан формат сохранения']
    B -->|Успех| C{Найти шаблон по\nИдентификаторКоманды}
    C -->|Не найден| C1[Сообщить: 'Шаблон не найден']
    C -->|Найден| D[ПолучитьСоединениеССервисом]
    
    subgraph D [Получение соединения]
        direction TB
        D1[Чтение констант] --> D2{Заполнена\nКмб_СтрокаПодключения?}
        D2 -->|Да| D3[Использовать значение из константы]
        D2 -->|Нет| D4[Использовать app.kombinator.ru]
        D3 & D4 --> D5[Определение режима сервера]
        D5 -->|Локальный режим| D6[Подключиться к 192.168.0.40:443]
        D5 -->|Облачный режим| D7[Подключиться к app.kombinator.ru:443]
        D6 & D7 --> D8[Создать SSL-соединение]
    end
    
    D --> E[ОтправитьЗапросНаАвторизацию]
    E --> F{Статус 200?}
    F -->|Нет| F1[Обработать ошибку авторизации]
    F -->|Да| G[ОтправитьЗапросНаГенерациюДокумента]
    
    subgraph G [Генерация документа]
        direction LR
        G1{Режим сохранения} -->|Кмб_СохранятьДокументыВКомбинаторе = Истина| G2[Эндпоинт: /api/v2/templates/createdocument]
        G1 -->|Ложь| G3[Эндпоинт: /api/v2/templates/generatedocument]
        G2 & G3 --> G4[Формирование тела запроса]
        
        subgraph G4 [Формирование данных]
            G41[ПолучитьСтруктуруДанныхДокумента] --> G42{Тип данных}
            G42 -->|Реквизиты объекта| G43[Обработка вложенности до 4 уровней]
            G42 -->|Табличные части| G44[Динамическое формирование колонок]
            G42 -->|Доп. реквизиты| G45[Запрос к метаданным по коду]
            G43 & G44 & G45 --> G46[Конвертация типов:\nЧисло/Дата/Булево → как есть,\nОстальные → Строка]
        end
    end
    
    G --> H{Статус 200?}
    H -->|Нет| H1[Десериализовать ошибку из JSON]
    H -->|Да| I{Режим сохранения}
    
    I -->|Сохранять в Комбинаторе| I1[Обработать ответ:\n- ID документа\n- Ссылка на документ]
    I1 --> I2[Сообщить пользователю:\n'Документ создан в системе Комбинатор']
    
    I -->|Сохранять в 1С| I3[Получить двоичные данные файла]
    I3 --> I4{Объект имеет\nприсоединенные файлы?}
    I4 -->|Да| I5[ПоместитьФайлВПрисоединенныеФайлы]
    I4 -->|Нет| I6[Сообщить: 'Нет доступа к присоединенным файлам']
    I5 --> I7[Сформировать структуру:\n- Автор\n- ВладелецФайлов\n- ИмяБезРасширения\n- РасширениеБезТочки]
    I7 --> I8[Сохранить файл в 1С]
    
    I2 & I6 & I8 --> J[Возврат результата]
    F1 & C1 & H1 & B1 --> J_Error[Возврат ошибки]
    
    J_Error --> K[Конец с ошибкой]
    J --> L[Конец с успехом]
    
    %% Стили для визуального разделения
    classDef service fill:#D6EAF8,stroke:#3498DB
    classDef data fill:#D5F5E3,stroke:#27AE60
    classDef error fill:#FADBD8,stroke:#E74C3C
    classDef mode fill:#EBDEF0,stroke:#9B59B6
    
    class D,G4 service;
    class G42,G43,G44,G45,G46 data;
    class G2,G3 mode;
    class F1,H1,C1,B1 error;
